<!doctype html>
<!--suppress JSUnfilteredForInLoop -->
<html lang="en">
<head>
    <title>Connection Manager</title>
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
    <style>
        .container {
            padding: 10px;
            text-align: center;
        }

        .left-element {
            display: inline-block;
            padding: 10px;
        }

        .spinner-border.text-primary {
            display: none;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <img alt="" id="logo" src="http://www.teamorlando.org/wp-content/uploads/2012/11/ARL-2016.jpg">
    <div class="row">
        <div aria-label="First group" class="btn-group mr-2" role="group">
            <!--            <button class="btn btn-dark btn-sm menu" type="button"><a href="indexAdmin.html">Managers Menu</a></button>-->
            <button class="btn btn-dark btn-sm menu active" type="button"><a href="connectionMan.html" id="pressed">Connection
                Manager</a></button>
            <button class="btn btn-dark btn-sm menu" type="button"><a href="accountsMan.html">Account Manager</a>
            </button>
            <button class="btn btn-dark btn-sm menu" type="button"><a href="platMan.html">Platform Manager</a></button>
        </div>
    </div>
</div>
<div style="text-align:center">
    <div class="container">
        <div class="left-element">
            <button id="startBtn" type="button">Start Polling</button>
            <button id="stopBtn" type="button">Stop Polling</button>
        </div>
        <div class="spinner-border text-primary" id="spinner" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>
<table class="table table-hover" id="connectionsTable">
    <thead>
    <tr>
        <th><a href="javascript:SortTable(0,'T', 'connectionsTable');">Connection Type</a></th>
        <th>Public IP</th>
        <th><a href="javascript:SortTable(2,'T', 'connectionsTable');">Username</a></th>
        <th><a href="javascript:SortTable(3,'T', 'connectionsTable');">Start Time</a></th>
        <th><a href="javascript:SortTable(4,'T', 'connectionsTable');">End Time</a></th>
        <th><a href="javascript:SortTable(5,'T', 'connectionsTable');">Status</a></th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<script src="/static/js/tablesorter.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script>
    let polling = false;
    $(document).ready(function () {
        $('#startBtn').click(function () {
            $.ajax({
                type: "PUT",
                url: "http://localhost:5001/api/v2/resources/connection",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    'command': 'start'
                }),
                success: function (response) {
                    console.log("Start Polling: " + response["success"]);
                    polling = true;
                    // $("#spinner").show();
                    $("#spinner").css("display", "inline-block");
                    poll_connection_status();
                },
            });
        });
    });
    $(document).ready(function () {
        $('#stopBtn').click(function () {
            $.ajax({
                type: "PUT",
                url: "http://localhost:5001/api/v2/resources/connection",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    'command': 'stop'
                }),
                success: function (response) {
                    console.log("Stop Polling: " + response["success"]);
                    polling = false;
                    $("#spinner").css("display", "none");
                },
            });
        });
    });

    function poll_connection_status() {
        if (polling) {
            // noinspection JSUnusedGlobalSymbols
            $.ajax({
                type: "GET",
                url: "http://localhost:5001/api/v2/resources/connection",
                contentType: "application/json",
                dataType: "json",
                data: {
                    'session_list': 'True'
                },
                success: function (response) {
                    console.log("Connections Updated at " + new Date().toUTCString());
                    let user_status = response["usersDictionary"];
                    let trHTML = '<tbody>';
                    for (let i in user_status) {
                        let public_ip = user_status[i]["public_ip"];
                        let end_time = user_status[i]["end_time"];
                        let start_time = user_status[i]["start_end"];
                        let username = user_status[i]["username"];
                        let status = user_status[i]["status"];
                        let connection_type = user_status[i]["connection_type"];
                        trHTML += `<tr>
                            <td>${connection_type}</td>
                            <td>${public_ip}</td>
                            <td>${username}</td>
                            <td>${start_time}
                            </td><td>${end_time}</td>
                            <td>${status}</td>
                        </tr>`;
                    }
                    trHTML += '</tbody>';
                    $('#connectionsTable tbody').replaceWith(trHTML);
                    SortTable(2, 'T', 'connectionsTable', true)
                },
                complete: function () {
                    // Schedule the next request when the current one's complete
                    setTimeout(poll_connection_status, 5000);
                }
            });
        }
    }
</script>
</body>
</html>
