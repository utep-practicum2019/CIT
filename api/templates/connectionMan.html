<!doctype html>
<!--suppress JSUnfilteredForInLoop -->
<html lang="en">
<head>
    <title>Connection Manager</title>
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
    <style>
        .container {
            padding: 10px;
            text-align: center;
        }

        .left-element {
            display: inline-block;
            padding: 10px;
        }

        .spinner-border.text-primary {
            display: none;
        }

        .navbar-nav.navbar-center {
            position: absolute;
            left: 50%;
            transform: translatex(-50%);
        }

        .nav-link.dropdown-toggle {
            font-weight: bold;
            color: #007bff !important;
        }

    </style>
</head>
<body>
<!--<div class="container-fluid">-->
<!--    <img alt="" id="logo" src="http://www.teamorlando.org/wp-content/uploads/2012/11/ARL-2016.jpg">-->
<!--    <div class="row">-->
<!--        <div aria-label="First group" class="btn-group mr-2" role="group">-->
<!--            &lt;!&ndash;            <button class="btn btn-dark btn-sm menu" type="button"><a href="indexAdmin.html">Managers Menu</a></button>&ndash;&gt;-->
<!--            <button class="btn btn-dark btn-sm menu active" type="button"><a href="connectionMan.html" id="pressed">Connection-->
<!--                Manager</a></button>-->
<!--            <button class="btn btn-dark btn-sm menu" type="button"><a href="accountsMan.html">Account Manager</a>-->
<!--            </button>-->
<!--            <button class="btn btn-dark btn-sm menu" type="button"><a href="platMan.html">Platform Manager</a></button>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->
<div class="container-fluid">
    <img alt="Responsive image" class="class=rounded mx-auto d-block"
         src="http://www.teamorlando.org/wp-content/uploads/2012/11/ARL-2016.jpg">
</div>
<div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">

        <ul class="navbar-nav">
            <li class="nav-item dropdown">
                <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                   data-toggle="dropdown" id="navbarDropdownMenuLink" role="button">
                    Connection Manager
                </a>
                <div aria-labelledby="navbarDropdownMenuLink" class="dropdown-menu">
                    <a class="nav-item nav-link active" href="connectionMan.html">Connection Manager<span
                            class="sr-only">(current)</span></a>
                    <a class="nav-item nav-link" href="accountsMan.html">Account Manager</a>
                    <!--                    <a class="nav-item nav-link" href="platMan.html">Platform Manager</a>-->
                </div>
            </li>
        </ul>

        <button aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"
                class="navbar-toggler"
                data-target="#navbarNavAltMarkup" data-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav navbar-center">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="dropdown-item"
                           id="startBtn">Start Polling</a>
                    </li>
                    <li class="nav-item active">
                        <a class="dropdown-item" id="stopBtn">Stop Polling</a>
                    </li>
                    <li class="nav-item active">
                        <div class="spinner-border text-primary" id="spinner" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>


<!--<div style="text-align:center">-->
<!--    <div class="container">-->
<!--        <div class="left-element">-->
<!--            <button id="startBtn" type="button">Start Polling</button>-->
<!--            <button id="stopBtn" type="button">Stop Polling</button>-->
<!--        </div>-->
<!--        -->
<!--    </div>-->
<!--</div>-->
<table class="table table-hover" id="connectionsTable">
    <thead>
    <tr>
        <th><a href="javascript:SortTable(0,'T', 'connectionsTable');">Connection Type</a></th>
        <th>Public IP</th>
        <th><a href="javascript:SortTable(2,'T', 'connectionsTable');">Username</a></th>
        <th><a href="javascript:SortTable(3,'T', 'connectionsTable');">Start Time</a></th>
        <th><a href="javascript:SortTable(4,'T', 'connectionsTable');">End Time</a></th>
        <th><a href="javascript:SortTable(5,'T', 'connectionsTable');">Status</a></th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js">
</script>
<script crossorigin="anonymous"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js">
</script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.min.js" type="text/javascript"></script>
<link href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/themes/ui-lightness/jquery-ui.css" rel="stylesheet"
      type="text/css"/>

<script src="/static/js/notify.js" type="text/javascript"></script>
<script src="/static/js/remarkable-bootstrap-notify/bootstrap-notify.js" type="text/javascript"></script>
<script src="/static/js/tablesorter.js"></script>
<script>
    let polling = false;
    $(document).ready(function () {
        $('#startBtn').click(function () {
            $.ajax({
                type: "PUT",
                url: "http://localhost:5001/api/v2/resources/connection",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    'command': 'start'
                }),
                success: function (response) {
                    console.log("Start Polling: " + response["success"]);
                    polling = true;
                    // $("#spinner").show();
                    $("#spinner").css("display", "inline-block");
                    poll_connection_status();
                },
            });
        });
    });
    $(document).ready(function () {
        $('#stopBtn').click(function () {
            $.ajax({
                type: "PUT",
                url: "http://localhost:5001/api/v2/resources/connection",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    'command': 'stop'
                }),
                success: function (response) {
                    console.log("Stop Polling: " + response["success"]);
                    polling = false;
                    $("#spinner").css("display", "none");
                },
            });
        });
    });

    function poll_connection_status() {
        if (polling) {
            // noinspection JSUnusedGlobalSymbols
            $.ajax({
                type: "GET",
                url: "http://localhost:5001/api/v2/resources/connection",
                contentType: "application/json",
                dataType: "json",
                data: {
                    'session_list': 'True'
                },
                success: function (response) {
                    console.log("Connections Updated at " + new Date().toUTCString());
                    let user_status = response["usersDictionary"];
                    let trHTML = '<tbody>';
                    for (let i in user_status) {
                        let public_ip = user_status[i]["public_ip"];
                        let end_time = user_status[i]["end_time"];
                        let start_time = user_status[i]["start_end"];
                        let username = user_status[i]["username"];
                        let status = user_status[i]["status"];
                        let connection_type = user_status[i]["connection_type"];
                        trHTML += `<tr>
                            <td>${connection_type}</td>
                            <td>${public_ip}</td>
                            <td>${username}</td>
                            <td>${start_time}
                            </td><td>${end_time}</td>
                            <td>${status}</td>
                        </tr>`;
                    }
                    trHTML += '</tbody>';
                    $('#connectionsTable tbody').replaceWith(trHTML);
                    SortTable(2, 'T', 'connectionsTable', true)
                },
                complete: function () {
                    // Schedule the next request when the current one's complete
                    setTimeout(poll_connection_status, 5000);
                }
            });
        }
    }
</script>
</body>
</html>
