<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Collaborative Innovation Testbed</title>

        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href = "{{ url_for('static', filename='css/bootstrap.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    </head>

    <body>

        <div class="container-fluid">
            <nav class="navbar navbar-light bg-white">
                <img id="logo" src="{{ url_for('static', filename='ARL.jpg') }}">
                <div class="col-3" id="displayMessages">

                </div>
                <div class="col-4">
                    <div id="userDisplay">
                        <h5 id="user">Username: {{ username }}</h5>
                        <h6>Group {{ group_id }}</h6>
                    <h6>
                    Team Members:
                        {% for member in team %}
                            {% if member != username %}
                                {{ member }}
                            {% endif %}
                        {% endfor %}
                    </h6>
                            {% if session['logged_in'] == True %}
                                <a id="logoutButton" href="/logout" class="btn btn-outline-dark btn-sm" role="button">Log out</a>
                            {% endif %}
                    </div>
                </div>
            </nav>
        </div>
        <div class="container-fluid">
            <ul class="nav nav-pills mb-3" id="platforms" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="pill" href="#news" role="tab" aria-controls="pills-news" aria-selected="true">News</a>
                </li>
                {% for platform in platforms %}
                <li class="nav-item">
                    <a class="nav-link" data-toggle="pill" href="{{'#{}'.format(platform.replace(' ', ''))}}" role="tab" aria-controls="{{ 'pills-{}'.format(platform.replace(' ', '')) }}" aria-selected="true">{{ platform }}</a>
                </li>
                {% endfor %}
<!--{#                <li class="nav-item">#}-->
<!--{#                    <a class="nav-link active" data-toggle="pill" href="#hackathon" role="tab" aria-controls="pills-profile" aria-selected="false">Hackathon</a>#}-->
<!--{#                </li>#}-->
            </ul>
            <div class="tab-content" id="subplatformsArea">
                <div class="tab-pane fade show active" id="news" role="tabpanel" aria-labelledby="pills-news-tab">
                    <h1 class="HelpText">News</h1>
                    <h5 class="HelpText">Hello and welcome to the Collaborative Innovative Testbed</h5>
                    <h6 class="HelpText">The news page contains all the information pertaining to any new changes</h6>
                    <br>
                    <p>
                        Spicy jalapeno bacon ipsum dolor amet officia sausage pork belly, dolor hamburger boudin meatloaf.
                        Tempor rump eiusmod in, venison porchetta sausage chicken meatball culpa aliquip duis quis t-bone
                        nisi. Pork loin tenderloin short ribs, pork belly turducken chicken tempor eiusmod picanha fatback.
                        Andouille sirloin kevin cillum, boudin est pancetta filet mignon sunt venison. Pig ground round laboris
                        officia fatback quis excepteur deserunt dolor swine cillum sirloin duis lorem drumstick.<br><br>

                        The following file contains the file needed for the Hackathon:
                        <a class="fileLinks" href="{{ url_for('static', filename='Download_Files/udpecho.pcap') }}" download>udpecho.pcap</a>
                        <br><br>


                        Ham reprehenderit ex capicola frankfurter adipisicing prosciutto quis venison nostrud sint corned beef
                        meatball aliqua. Dolore pork chop corned beef sed turducken ullamco. Ham jerky ut, in sunt quis frankfurter
                        fugiat chicken aute sed velit. Ipsum t-bone fugiat incididunt mollit ad. Kevin sirloin sint, boudin chicken
                        commodo minim. Ut ad frankfurter flank shoulder.<br>

                        Venison laboris dolor, labore eiusmod non tail. Et sausage nostrud, non landjaeger ut kielbasa picanha ullamco
                        pig dolor filet mignon beef deserunt. Officia landjaeger corned beef, tongue reprehenderit flank duis non
                        frankfurter. Id ad anim shankle, turducken elit porchetta short loin picanha nulla meatball pariatur.
                        Excepteur laboris venison, sunt brisket tongue ham hock. Nisi aliquip tri-tip pastrami dolore kevin ex irure
                        voluptate venison.<br><br>

                        Pig buffalo irure porchetta ribeye in. Hamburger adipisicing bresaola elit, salami flank pork chop spare ribs
                        cupim. Est picanha chicken incididunt ribeye short loin minim pork loin fugiat buffalo eiusmod salami. Labore
                        ipsum ham, in ea burgdoggen exercitation eiusmod.<br><br>

                        Landjaeger cupim deserunt turducken, shankle ipsum ex ham hock alcatra pig frankfurter picanha chicken ad jerky.
                        Chuck ribeye quis jowl aliqua do nulla officia beef. Prosciutto boudin laborum leberkas fatback shoulder officia
                        landjaeger aliqua cow tenderloin tongue. Shank tenderloin pastrami jerky. Laboris tenderloin voluptate flank,
                        ea in turkey. Pork belly pancetta salami fatback landjaeger meatball voluptate.<br><br>

                        Venison laboris dolor, labore eiusmod non tail. Et sausage nostrud, non landjaeger ut kielbasa picanha ullamco
                        pig dolor filet mignon beef deserunt. Officia landjaeger corned beef, tongue reprehenderit flank duis non
                        frankfurter. Id ad anim shankle, turducken elit porchetta short loin picanha nulla meatball pariatur. Excepteur
                        laboris venison, sunt brisket tongue ham hock. Nisi aliquip tri-tip pastrami dolore kevin ex irure voluptate
                        venison.<br><br>

                        Meatloaf sausage pork loin enim cow fugiat short loin irure dolor reprehenderit nostrud tri-tip flank dolore.
                        Swine nulla in, cow dolore ham minim laboris laborum reprehenderit ad anim cillum frankfurter. Chicken ribeye
                        pig strip steak, in doner cow tempor pastrami ham hock. Pork belly bresaola quis ullamco pastrami spare ribs
                        cupidatat prosciutto culpa pork corned beef cupim.<br><br>
                    </p>
                </div>
        {% for id in platforms_id %}
            {% for result in ogList %}
                {% for key, values in result.items() %}
                <div class="tab-pane fade" id="{{ '{}'.format(key.replace(' ', '')) }}" role="tabpanel" aria-labelledby="{{ 'pills-{}-tab'.format(key.replace(' ', '')) }}">
                    <div class="row">
                        <div class="col-2">
                            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                    {% for  v in values %}
                                        {% if v[0] != "IDS Virtual Machine" and v[0] != "VirtualMachine" %}

                                            <a class="nav-link" data-toggle="pill" href="{{'#{}-{}'.format(key.replace(' ', ''), v[0].replace(' ', '')) }}" role="tab" aria-controls="{{ 'v-pills-{}-{}'.format(key.replace(' ', ''), v[0].replace(' ', '')) }}" aria-selected="true">
                                                {% if v[0] == 'FilesUpload' %}
                                                    Challenges
                                                {% elif v[0] == 'FilesDownload' %}
                                                    Materials
                                                {% else %}
                                                    {{ v[0] }}
                                                {% endif %}
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                            </div>
                        </div>
                        <div class="col-9">
                            <div class="tab-content" id="v-pills-tabContent">
                                {% for v in values %}
                                    <div class="tab-pane fade" id="{{ '{}-{}'.format(key.replace(' ', ''), v[0].replace(' ', '')) }}" role="tabpanel" aria-labelledby="{{ 'v-pills-{}-{}-tab'.format(key.replace(' ', ''), v[0].replace(' ', '')) }}">
                                        {% if v[0] == "FilesUpload" %}
                                            <div class="accordion" id="accordionExample">
                                                <div class="card">
                                                    <div class="card-header" id="headingOne">
                                                        <h2 class="mb-0">
                                                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                                                Hackathon Challenge #1
                                                            </button>
                                                        </h2>
                                                    </div>

                                                    <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                                                        <div class="card-body">
                                                            <div id="wrapper">
                                                                <p>
                                                                    Meatloaf sausage pork loin enim cow fugiat short loin irure dolor reprehenderit
                                                                    nostrud tri-tip flank dolore. Swine nulla in, cow dolore ham minim laboris laborum
                                                                    reprehenderit ad anim cillum frankfurter. Chicken ribeye pig strip steak, in doner
                                                                    cow tempor pastrami ham hock. Pork belly bresaola quis ullamco pastrami spare ribs
                                                                    cupidatat prosciutto culpa pork corned beef cupim.<br><br>
                                                                </p>
                                                                <h6>Upload File</h6>
                                                                <form id="file-form" method=post enctype=multipart/form-data>
                                                                    <input id='file-select' type=file name=file>
                                                                        <button type="submit" id="uploadBtn" class="btnDisable">Upload</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card">
                                                    <div class="card-header" id="headingTwo">
                                                        <h2 class="mb-0">
                                                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                                                Hackathon Challege #2
                                                            </button>
                                                        </h2>
                                                    </div>
                                                    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                                                        <div class="card-body">
                                                            <div>
                                                                <p>
                                                                    Venison laboris dolor, labore eiusmod non tail. Et sausage nostrud, non landjaeger
                                                                    ut kielbasa picanha ullamco pig dolor filet mignon beef deserunt. Officia landjaeger
                                                                    corned beef, tongue reprehenderit flank duis non frankfurter. Id ad anim shankle,
                                                                    turducken elit porchetta short loin picanha nulla meatball pariatur. Excepteur
                                                                    laboris venison, sunt brisket tongue ham hock. Nisi aliquip tri-tip pastrami
                                                                    dolore kevin ex irure voluptate venison.<br><br>
                                                                </p>
                                                                <h6>Upload File</h6>
                                                                <form method=post enctype=multipart/form-data>
                                                                    <p><input type=file name=file>
                                                                        <button type="submit" class="btnDisable">Upload</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card">
                                                    <div class="card-header" id="headingThree">
                                                        <h2 class="mb-0">
                                                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                                                Hackathon Challenge #3
                                                            </button>
                                                        </h2>
                                                    </div>
                                                    <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                                                        <div class="card-body">
                                                            <div>
                                                                <p>
                                                                    Ham reprehenderit ex capicola frankfurter adipisicing prosciutto quis venison
                                                                    nostrud sint corned beef meatball aliqua. Dolore pork chop corned beef sed
                                                                    turducken ullamco. Ham jerky ut, in sunt quis frankfurter fugiat chicken aute
                                                                    sed velit. Ipsum t-bone fugiat incididunt mollit ad. Kevin sirloin sint, boudin
                                                                    chicken commodo minim. Ut ad frankfurter flank shoulder.<br><br>
                                                                </p>
                                                                <h6>Upload File</h6>
                                                                <form method=post enctype=multipart/form-data>
                                                                    <p><input type=file name=file>
                                                                        <button type="submit" class="btnDisable">Upload</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif v[0] == "Results" %}
                                            <span title="{{id}},{{v[2]}}" style="display: none" id="ResultIDs">{{id}},{{v[2]}}</span>
                                            <div id="showResults">
                                                Please upload a file in the Challenges Platform to get your results
                                            </div>
                                        {% elif v[0] == "FilesDownload" %}
                                            <div class="container-fluid">
                                                <h3>Below are the files available for download</h3><br>
                                                <div class="accordion" id="accordionExample">
                                                    {% for path, files in downloadable_files.items() %}
                                                    <div class="card">
                                                        <div class="card-header" id="'{}{}'.format(key, path) }}">
                                                            <h2 class="mb-0">
                                                                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="{{'#{}'.format(path)}}" aria-expanded="false" aria-controls="{{'#{}'.format(path)}}">
                                                                    {{ path.replace('-', '/') }}
                                                                </button>
                                                            </h2>
                                                        </div>

                                                        <div id="{{'{}'.format(path)}}" class="collapse" aria-labelledby="'{}{}'.format(key, path) }}" data-parent="#accordionExample">
                                                            <div class="card-body">
                                                                    {% for file in files %}
                                                                        <a class="fileLinks" href="{{ '/{}/{}'.format(path,file) }}" download>{{ file }}</a><br>
                                                                    {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% elif v[0] == "Rocketchat" %}
                                            <iframe id="rocketchat" src="{{ 'http://{}'.format(v[1]) }}"></iframe>
<!--                                        {% for file in downloadable_files %}-->
<!--                                        <a class="fileLinks" href="{{ url_for('static', filename='{}/{}'.format(read_directory, file)) }}" download>{{ file }}</a><br>-->
<!--                                        {% endfor %}-->
                                        {% else  %}
<!--                                            {{ key }}-->
                                          <iframe src="{{ 'http://{}'.format(v[1]) }}"></iframe>
<!--                                            <h3>{{ v[1] }}</h3>-->
                                        {% endif %}
                                    </div>
                                {% endfor%}
                            </div>
                        </div>

                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        {% endfor %}
            </div>
        </div>

<!--        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>-->
        <script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js') }}" ></script>
        <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
        <script src = "{{ url_for('static', filename='js/bootstrap.js') }}"></script>
        <script src = "{{ url_for('static', filename='js/bootstrap.bundle.js') }}"></script>
        <script>

            let repeat = 44;
            let filename = 'nofileyet.txt'

            // $(function(){
            //     var hash = window.location.hash;
            //     hash && $('ul.nav a[href="' + '#Hackathon' + '"]').tab('show');
            //     hash && $('#Hackathon a[href="' + '#Hackathon-Results' + '"]').tab('show');
            //
            //     setTimeout(getStatus, 2000);  // calling in 2 seconds
            //     console.log("first getStatus scheduled");
            //
            //     $('#uploadBtn').click(function(e){
            //           $(this).tab('show');
            //           var scrollmem = $('body').scrollTop() || $('html').scrollTop();
            //           window.location.hash = this.hash;
            //           $('html, body').scrollTop(scrollmem);
            //     });
            // });

            function getStatus() {
                console.log('getting status...');
                var ids = document.getElementById("ResultIDs").innerText;
                ids = ids.split(",")
                console.log(ids);
                $.ajax({
                    type: "PUT",
                    url: "http://129.108.7.29:5001/api/v2/resources/platform",  // ???
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({
                        "command": "configure",
                        "platform_ID": ids[0],
                        "subplatforms_IDS": [ids[1]],
                        "configuration": {
                            "command": "getStatus",
                            "param": {
                                "filename": filename
                            }
                        }
                    }),
                    success: function (response) {
                        console.log(response)
                        let tmp = Object.keys(response)[0]
                        console.log(tmp)
                        if (tmp == "success" && !response['success']) {
                            alert('request did not succeed')
                        } else if (tmp == "done" && response['done']) {
                            console.log("status: " + response["done"]);
                            showResults(ids)
                        } else if (repeat >= 0){
                            setTimeout(getStatus, 2000);  // calling every 2 seconds
                            repeat--;
                        } else {
                            alert('request did not succeed: request timed out');
                            document.getElementById("showResults").innerHTML = '<p>' +
                                'Please upload a file in the Challenges Platform to get your results' +
                                '</p>'
                            repeat = 44;
                        }

                    }
                });
            }

            function showResults(ids) {
                $.ajax({
                    type: "PUT",
                    url: "http://129.108.7.29:5001/api/v2/resources/platform",  // ???
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({
                        "command": "configure",
                        "platform_ID": ids[0],
                        "subplatforms_IDS": [ids[1]],
                        "configuration": {
                            "command": "getResults",
                            "param": {
                                "filename": filename
                            }
                        }
                    }),
                    success: function (response) {
                        console.log(response)
                        let tmp = Object.keys(response)[0]
                        console.log(tmp)
                        if (tmp == "success" && !response['success']) {
                            alert('request did not succeed')
                        } else if (tmp == "results" && response['results']) {
                            alert("Results have arrived!");
                            if (response['results'] == 48){
                                document.getElementById("showResults").innerHTML = '\
                                <div class="alert alert-success" role="alert"> \
                                    <h1>Alerts Received: ' + response['results'] + '<br></h1> \
                                    <h1>Alerts Expected: 48<br></h1> \
                                </div>'
                            } else {
                                document.getElementById("showResults").innerHTML = '\
                                <div class="alert alert-warning" role="alert"> \
                                    <h1>Alerts Received: ' + response['results'] + '<br></h1> \
                                    <h1>Alerts Expected: 48<br></h1> \
                                </div>'
                            }

                        }
                    }
                });

            }

        $('#file-form').submit( function(e) {
            console.log('file-method');
            e.preventDefault();
                var form_data = new FormData($('#file-form')[0]);
                var formInput = document.getElementById("file-select");

                $.ajax({
                    type: 'POST',
                    url: '/fileUpload',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {
                        filename = data
                        console.log('Success!');
                        var hash = window.location.hash;

                        document.getElementById('file-select').value='';

                        hash && $('ul.nav a[href="' + '#Hackathon' + '"]').tab('show');
                        hash && $('#Hackathon a[href="' + '#Hackathon-Results' + '"]').tab('show');


                        repeat = 44;
                        setTimeout(getStatus, 2000);  // calling in 2 seconds
                        console.log("first getStatus scheduled");

                        // $(this).tab('show');
                        var scrollmem = $('body').scrollTop() || $('html').scrollTop();
                        window.location.hash = this.hash;
                        $('html, body').scrollTop(scrollmem);
                    },
            });
            var hash = window.location.hash;
            hash && $('ul.nav a[href="' + '#Hackathon' + '"]').tab('show');
            hash && $('#Hackathon a[href="' + '#Hackathon-Results' + '"]').tab('show');

            var scrollmem = $('body').scrollTop() || $('html').scrollTop();
            window.location.hash = this.hash;
            $('html, body').scrollTop(scrollmem);

            document.getElementById("showResults").innerHTML = '\
                    <button class="btn btn-primary" type="button" disabled> \
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> \
                        Loading Results... \
                    </button>'
        });

        </script>
    </body>
</html>